{% include "/public/header.html" %}
<div class="layui-card">
    <div class="layui-card-header">{{res.h1}}</div>
    <form class="layui-form" lay-filter="report_info">
        <div class="layui-card-body">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">项目名称</label>
                    <div class="layui-input-block">
                        <div id="report_center"></div>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">系统名称</label>
                    <div class="layui-input-block">
                        <div id="report_systemname"></div>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">访问地址</label>
                    <div class="layui-input-block">
                        <!-- <div id="report_test_url"></div> -->
                        <input type="text" name="report_test_url" id="report_test_url" class="layui-input"
                            style="width: 300px;">
                    </div>
                </div>
            </div>
        </div>
    </form>
    <blockquote class="layui-elem-quote" style="
    color: red;
">
        ① 如需要导出整个项目请保持【系统名称】为空，导出单个系统报告，则必须选择对应【系统名称】<br>
        ② 为防止数据泄露,建议确认报告无误及时清理项目数据<br>
        ③ 图片不清晰是因为从word中复制出来所导致，请在【添加漏洞】时使用编辑器的【导入word】功能，第二行第四个图标
        ④ 首次导出失败,通常是因为当前运行环境缺少office或pandoc程序,请查看readme.pdf进行安装
    </blockquote>
    <div class="layui-card-body">
        <table id="demo" lay-filter="test"></table>
        <script type="text/html" id="toolbarDemo">
            <div class="layui-btn-container">
              <!-- <button class="layui-btn layui-btn-sm" lay-event="add">添加</button> -->
              <button class="layui-btn  layui-btn-primary  layui-border-orange layui-btn-sm " lay-event="export">导出</button> 
              <button class="layui-btn  layui-btn-primary  layui-border-red layui-btn-sm" lay-event="del">删除</button> 
            </div>
          </script>
        <!-- <button type="button" class="layui-btn layui-btn-primary layui-btn-fluid">添加漏洞</button> -->
    </div>
</div>
<script type="text/html" id="barDemo">
    <div class="layui-clear-space">
      <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    </div>
  </script>
<script>
    //Demo
    layui.extend({ selectInput: "{{ url_for('static', filename='js/selectInput') }}" });

    layui.use(['form', 'laydate', 'table', "jquery", "selectInput"], function () {
        var form = layui.form,
            laydate = layui.laydate,
            table = layui.table,
            jq = layui.jquery;
        //渲染所属项目下拉框
        var selectinput_report_center = selectInput.render({
            elem: "#report_center",
            // url: 'https://shop.douaili.com/api/v1/user/test',
            url: "api",
            params: {
                action: "report_center"
            },
            name: "report_center",
            localSearch: true,
            clickClose: true,
            hasSelectIcon: true,
            //通过选择下拉框渲染所属项目相关的系统下拉框

            onClick: function (res) {
                // console.log(res.value)
                jq.ajax({
                    url: "api",
                    data: {
                        action: "report_systemname",
                        report_center: res.value
                    },
                    dataType: "json",
                    type: "GET",
                    success: function (res) {
                        data = res.data
                        selectinput_report_systemname.append(data, false)
                    }
                })
                // 渲染数据表格
                table.reload('demo', {
                    url: 'api' //数据接口
                    , where: {
                        action: "vul_list",
                        report_center: res.value,
                    }
                    //,height: 300
                });
            }
        })
        //渲染所属系统下拉框
        var selectinput_report_systemname = selectInput.render({
            elem: "#report_systemname",
            name: "report_systemname",
            localSearch: true,
            hasSelectIcon: true,
            clickClose: true,
            // 通过点击获取所属系统漏洞数据
            onClick: function (res) {
                var report_info = form.val("report_info");
                // 获取访问地址
                jq.ajax({
                    url: "api",
                    data: {
                        action: "report_test_url",
                        report_center: selectinput_report_center.getValue(),
                        report_systemname: res.value
                    },
                    dataType: "json",
                    type: "GET",
                    success: function (res) {
                        data = res.data
                        // selectinput_report_test_url.append(data['report_test_url'], false)
                        // selectinput_report_author.append(data['report_author'], false)

                        jq("#report_test_url").val(data["report_test_url"])
                        jq("#report_start_time").val(data["report_start_time"])
                        jq("#report_end_time").val(data["report_end_time"])

                    }
                })

                // 渲染数据表格
                table.reload('demo', {
                    url: 'api' //数据接口
                    , where: {
                        action: "vul_list",
                        report_center: selectinput_report_center.getValue(),
                        report_systemname: res.value
                    }
                    //,height: 300
                });
            }
        })


        //渲染漏洞管理表格
        table.render({
            elem: '#demo'
            , height: 500
            , url: 'api' //数据接口
            , where: { action: "vul_list" }
            , page: false //开启分页
            , toolbar: '#toolbarDemo'
            , cols: [[ //表头
                { type: 'checkbox', fixed: 'left' }
                , { field: 'id', title: 'ID', width: 80, sort: true }
                , { field: 'report_center', title: '项目名称', sort: true }
                , { field: 'report_systemname', title: '系统名称', sort: true }
                , { field: 'report_test_url', title: '访问地址', sort: true }
                , { field: 'vul_type_name', title: '漏洞类型', sort: true }
                , { field: 'vul_name', title: '漏洞名称', sort: true }
                , { field: 'vul_level', title: '漏洞等级', width: 120, sort: true }
                , { field: 'vul_url', title: '漏洞url' }
                , { fixed: 'right', title: '操作', width: 134, minWidth: 125, toolbar: '#barDemo' }
            ]]
        });

        //漏洞管理顶部工具栏按钮点击事件
        table.on('toolbar(test)', function (obj) {
            var checkStatus = table.checkStatus(obj.config.id);
            //获取表单区域所有值
            var report_info = form.val("report_info");
            switch (obj.event) {
                case 'add'://添加功能
                    // if (report_info.report_author == "" || report_info.report_start_time == "" || report_info.report_end_time == "" || report_info.report_test_url == "") {
                    //     layer.msg("报告管理处输入框不能为空")
                    // } else {
                    layer.open({
                        title: "添加漏洞",
                        area: ['1600px', '900px'],
                        type: 2,
                        content: '/vul?action=add&report_center=' + report_info.report_center + '&report_systemname=' + report_info.report_systemname + '&report_author=' + report_info.report_author + '&report_start_time=' + report_info.report_start_time + '&report_end_time=' + report_info.report_end_time + '&report_test_url=' + report_info.report_test_url + '&report_test_ip=' + report_info.report_test_ip

                    });
                    // }
                    break;
                case 'export'://导出功能
                    layer.confirm('确定导出吗?', { icon: 3, title: '提示' }, function (index) {
                        jq.ajax({
                            url: "api",
                            data: {
                                action: "report_export",
                                report_center: report_info.report_center,
                                report_systemname: report_info.report_systemname
                            },
                            dataType: "json",
                            type: "GET",
                            beforeSend: function () {
                                layer.msg('正在处理，请稍等，可通过控制台查看进度......', {
                                    icon: 6,
                                    time: 120000
                                });
                            },
                            success: function (res) {
                                data = res.data
                                layer.open({
                                    content: '<a href="' + data + '">请点击链接进行下载</a>'
                                })
                            }
                        })
                    })

                    break;
                case "del":
                    layer.confirm('确定删除所选吗?', { icon: 3, title: '提示' }, function (index) {
                        //do something
                        var checkStatus = table.checkStatus('demo'); //idTest 即为基础参数 id 对应的值
                        var ids = "";
                        for (i = 0; i < checkStatus.data.length; i++) {
                            console.log(checkStatus.data[i]);
                            ids += checkStatus.data[i].id + ","
                        }

                        jq.ajax({
                            url: "api",
                            data: {
                                action: "del",
                                ids: ids,
                            },
                            dataType: "json",
                            type: "POST",
                            success: function (res) {
                                data = res.data
                                layer.msg(data)
                                location.reload();
                            }
                        })
                        layer.close(index);
                    });
                    break;
            };
        });

        // 触发行内单元格工具事件
        table.on('tool(test)', function (obj) { // 双击 toolDouble
            var data = obj.data; // 获得当前行数据
            if (obj.event === 'edit') {
                window.location.href = 'add?id=' + data.id;
            }
        });

    });
</script>
</body>

</html>